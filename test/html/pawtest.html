
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Test integration over nuisance parameters</title><meta name="generator" content="MATLAB 9.8"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2020-10-25"><meta name="DC.source" content="pawtest.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }
span.typesection { color:#A0522D }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>Test integration over nuisance parameters</h1><!--introduction--><p>Based on Example 10.1 in Pawitan, <i>In All Likelihood</i> , which in turn is based on Neyman &amp; Scott (1948), <tt>doi:10.2307/1914288</tt>.</p><p>Consider a set of samples <img src="pawtest_eq00202618083486081978.png" alt="$x_{i1}$" style="width:12px;height:7px;"> and <img src="pawtest_eq14856677101992253096.png" alt="$x_{i2}$" style="width:13px;height:7px;"> from <img src="pawtest_eq11316547643946200379.png" alt="$N(\mu_i, \sigma^2)$" style="width:44px;height:12px;">, <img src="pawtest_eq09832353930495072392.png" alt="$i = 1, 2, \ldots, N$" style="width:69px;height:10px;">, where the parameter of interest is <img src="pawtest_eq12624043070620070374.png" alt="$\sigma^2$" style="width:10px;height:10px;">. The maximum likelihood estimate is inconsistent, with</p><p><img src="pawtest_eq01928832892278805439.png" alt="$$&#xA;\lim_{N\rightarrow\infty}\widehat{\sigma^2} = \sigma^2/2.&#xA;$$" style="width:74px;height:20px;"></p><p>Here, we use a Hamiltonian Monte Carlo sampler to integrate out the nuisance parameter vector <img src="pawtest_eq01796281038447804490.png" alt="$\mathbf{\mu}$" style="width:7px;height:8px;"> and obtain an accurate estimate of <img src="pawtest_eq12624043070620070374.png" alt="$\sigma^2$" style="width:10px;height:10px;">.</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Preliminaries</a></li><li><a href="#2">Define prior probability density</a></li><li><a href="#3">Define log posterior</a></li><li><a href="#4">Create HMC sampler</a></li><li><a href="#5">Estimate MAP point</a></li><li><a href="#6">Tune sampler</a></li><li><a href="#7">Draw samples</a></li><li><a href="#8">Examine convergence diagnostics</a></li><li><a href="#9">Visualize samples</a></li></ul></div><h2 id="1">Preliminaries</h2><p>Read in data</p><pre class="codeinput">Dat = csvread(<span class="string">'pawdata.txt'</span>);
mu = Dat(:,2);
X = Dat(:,3:4);
xbar = Dat(:,5);
trueSigma = 1;
</pre><h2 id="2">Define prior probability density</h2><p>We choose broad normal distributions as relatively uninformative priors for both <img src="pawtest_eq15744153947596428922.png" alt="$\log(\sigma^2)$" style="width:33px;height:12px;"> and <img src="pawtest_eq01796281038447804490.png" alt="$\mathbf{\mu}$" style="width:7px;height:8px;">.</p><pre class="codeinput">LogVariancePriorMean = 0;
LogVariancePriorSigma = 2;
MeanPriorMean = 0;
MeanPriorSigma = 20;
</pre><h2 id="3">Define log posterior</h2><pre class="codeinput">logpdf = @(P) logPosterior(P, X,<span class="keyword">...</span>
LogVariancePriorMean, LogVariancePriorSigma, <span class="keyword">...</span>
MeanPriorMean, MeanPriorSigma);
</pre><h2 id="4">Create HMC sampler</h2><pre class="codeinput">logSigmaEst = log(mean(std(X, 0, 2)));
muEst = xbar;
startpoint = [logSigmaEst; muEst];
smp = hmcSampler(logpdf, startpoint, <span class="string">'NumSteps'</span>,50);
</pre><h2 id="5">Estimate MAP point</h2><pre class="codeinput">[MAPpars,fitInfo] = estimateMAP(smp,<span class="string">'VerbosityLevel'</span>,0);
MAPlogSigma = MAPpars(1);
MAPmu = MAPpars(2:end);

plot(fitInfo.Iteration,fitInfo.Objective,<span class="string">'ro-'</span>);
xlabel(<span class="string">'Iteration'</span>);
ylabel(<span class="string">'Negative log density'</span>);
</pre><img vspace="5" hspace="5" src="pawtest_01.png" alt=""> <h2 id="6">Tune sampler</h2><pre class="codeinput">[smp,tuneinfo] = tuneSampler(smp,<span class="string">'Start'</span>,MAPpars);

figure;
plot(tuneinfo.StepSizeTuningInfo.StepSizeProfile);
xlabel(<span class="string">'Iteration'</span>);
ylabel(<span class="string">'Step size'</span>);

fprintf(<span class="string">"accratio = %.4f\n"</span>, tuneinfo.StepSizeTuningInfo.AcceptanceRatio)
</pre><pre class="codeoutput">accratio = 0.6400
</pre><img vspace="5" hspace="5" src="pawtest_02.png" alt=""> <h2 id="7">Draw samples</h2><pre class="codeinput">NumChains = 4;
chains = cell(NumChains,1);
Burnin = 500;
NumSamples = 1000;
<span class="keyword">for</span> c = 1:NumChains
    <span class="keyword">if</span> (c == 1)
        level = 1;
    <span class="keyword">else</span>
        level = 0;
    <span class="keyword">end</span>
    chains{c} = drawSamples(smp,<span class="string">'Start'</span>,MAPpars + randn(size(MAPpars)), <span class="keyword">...</span>
        <span class="string">'Burnin'</span>,Burnin,<span class="string">'NumSamples'</span>,NumSamples, <span class="keyword">...</span>
        <span class="string">'VerbosityLevel'</span>,level,<span class="string">'NumPrint'</span>,300);
<span class="keyword">end</span>
</pre><pre class="codeoutput">

|==================================================================================|
|   ITER   |    LOG PDF    |  STEP SIZE  |  NUM STEPS  |  ACC RATIO  |  DIVERGENT  |
|==================================================================================|
|      300 | -1.340758e+02 |   6.639e-01 |           3 |   8.433e-01 |           0 |
|      600 | -1.350505e+02 |   1.837e-02 |           3 |   8.550e-01 |           0 |
|      900 | -1.370153e+02 |   3.860e-01 |           7 |   8.478e-01 |           0 |
|     1200 | -1.307006e+02 |   6.639e-01 |           2 |   8.508e-01 |           0 |
|     1500 | -1.356701e+02 |   1.811e-01 |           4 |   8.553e-01 |           0 |
</pre><h2 id="8">Examine convergence diagnostics</h2><pre class="codeinput">diags = diagnostics(smp,chains);
truePars = [log(trueSigma^2);mu];
disp(diags)
disp(truePars)
</pre><pre class="codeoutput">     Name        Mean         MCSE        SD          Q5          Q95        ESS       RHat 
    _______    _________    ________    _______    _________    ________    ______    ______

    {'x1' }    -0.056675    0.011024      0.331     -0.57984     0.52898    901.52    1.0031
    {'x2' }     -0.42656    0.013588    0.73029      -1.6134     0.74786    2888.8    1.0015
    {'x3' }       3.3703    0.013978    0.70814       2.1925      4.5291    2566.7    1.0006
    {'x4' }       2.2575    0.012798    0.69394       1.1201      3.4247    2940.2    1.0013
    {'x5' }      -5.9854    0.013078    0.70269      -7.1387     -4.8798    2887.1    1.0006
    {'x6' }        3.416    0.013545    0.72644       2.2052      4.5954    2876.4         1
    {'x7' }      -3.2143    0.012933    0.69915      -4.3569     -2.1052    2922.3         1
    {'x8' }      -2.6146    0.014424    0.71442      -3.7482     -1.4257    2453.3    1.0014
    {'x9' }        6.704    0.012287    0.68225       5.6018       7.807    3083.3         1
    {'x10'}     -0.93691    0.012904    0.72251      -2.1179     0.25175    3134.9         1
    {'x11'}      -3.9466    0.012037    0.69014      -5.0898     -2.7978    3287.3    1.0001
    {'x12'}       7.8328    0.013947    0.72322       6.6609      9.0276      2689    1.0008
    {'x13'}      0.33647    0.012841    0.72234      -0.8221      1.5114    3164.2    1.0003
    {'x14'}       4.7587    0.012378    0.67534       3.6306      5.8772    2976.8         1
    {'x15'}       4.8444    0.013404      0.724       3.6385       6.001    2917.5         1
    {'x16'}      -4.6148    0.013341    0.71928      -5.8052     -3.4583    2906.9         1
    {'x17'}      -7.0431    0.012513    0.69419      -8.1727     -5.8771    3077.6    1.0002
    {'x18'}      -1.6608    0.012191     0.7004      -2.8266    -0.51616    3300.7         1
    {'x19'}      -7.7642    0.012109     0.6834      -8.8697     -6.6801    3185.1         1
    {'x20'}      -6.2965    0.012401    0.69676       -7.455     -5.1618    3156.7    1.0005
    {'x21'}       1.1104    0.013371    0.73668    -0.060796      2.3132    3035.6    1.0005

         0
    0.8800
    2.5100
    1.7400
   -6.7400
    1.4200
   -3.3400
   -2.7200
    6.8900
    0.6700
   -4.1800
    8.4300
    0.1500
    3.8900
    4.5200
   -4.0500
   -6.9500
   -2.6100
   -6.5200
   -6.0600
    0.9200

</pre><h2 id="9">Visualize samples</h2><pre class="codeinput">figure;
plot(chains{1}(:,1))
title(<span class="string">"log(\sigma^2), Chain 1"</span>)

figure;
plot(chains{1}(:,2))
title(<span class="string">"\mu_1, Chain 1"</span>)

concatenatedSamples = vertcat(chains{:});
figure;
histogram(exp(concatenatedSamples(:,1)))
xline(trueSigma^2,<span class="string">'r-'</span>,<span class="string">'LineWidth'</span>,1)
xline(mean(exp(concatenatedSamples(:,1))),<span class="string">'k-'</span>,<span class="string">'LineWidth'</span>,1)
xlabel(<span class="string">"\sigma^2"</span>)
ylabel(<span class="string">"Frequency"</span>)

Fig = figure;
Fig.Position = Fig.Position.*[0.5 0.5 1.5 1.5];
N = length(mu);
ax = gobjects(N,1);
<span class="keyword">for</span> i = 1:N
    ax(i) = subplot(4,5,i);
    histogram(concatenatedSamples(:,i+1))
    xline(mu(i),<span class="string">'r-'</span>,<span class="string">'LineWidth'</span>,1)
    xline(mean(concatenatedSamples(:,i+1)),<span class="string">'k-'</span>,<span class="string">'LineWidth'</span>,1)
    xlim([-10 10]);
    ax(i).XTickLabel = {};
    ax(i).YTickLabel = {};
<span class="keyword">end</span>
</pre><img vspace="5" hspace="5" src="pawtest_03.png" alt=""> <img vspace="5" hspace="5" src="pawtest_04.png" alt=""> <img vspace="5" hspace="5" src="pawtest_05.png" alt=""> <img vspace="5" hspace="5" src="pawtest_06.png" alt=""> <p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2020a</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Test integration over nuisance parameters
% Based on Example 10.1 in Pawitan, _In All Likelihood_ , which in turn is
% based on Neyman & Scott (1948), |doi:10.2307/1914288|.
%
% Consider a set of samples $x_{i1}$ and $x_{i2}$ from $N(\mu_i,
% \sigma^2)$, $i = 1, 2, \ldots, N$, where the parameter of interest is
% $\sigma^2$. The maximum likelihood estimate is inconsistent, with
%
% $$
% \lim_{N\rightarrow\infty}\widehat{\sigma^2} = \sigma^2/2.
% $$
%
% Here, we use a Hamiltonian Monte Carlo sampler to integrate out the
% nuisance parameter vector $\mathbf{\mu}$ and obtain an accurate estimate
% of $\sigma^2$.

%% Preliminaries
% Read in data
Dat = csvread('pawdata.txt');
mu = Dat(:,2);
X = Dat(:,3:4);
xbar = Dat(:,5);
trueSigma = 1;

%% Define prior probability density
% We choose broad normal distributions as relatively uninformative priors
% for both $\log(\sigma^2)$ and $\mathbf{\mu}$.
LogVariancePriorMean = 0;
LogVariancePriorSigma = 2;
MeanPriorMean = 0;
MeanPriorSigma = 20;

%% Define log posterior
logpdf = @(P) logPosterior(P, X,...
LogVariancePriorMean, LogVariancePriorSigma, ...
MeanPriorMean, MeanPriorSigma);

%% Create HMC sampler
logSigmaEst = log(mean(std(X, 0, 2)));
muEst = xbar;
startpoint = [logSigmaEst; muEst];
smp = hmcSampler(logpdf, startpoint, 'NumSteps',50);

%% Estimate MAP point

[MAPpars,fitInfo] = estimateMAP(smp,'VerbosityLevel',0);
MAPlogSigma = MAPpars(1);
MAPmu = MAPpars(2:end);

plot(fitInfo.Iteration,fitInfo.Objective,'ro-');
xlabel('Iteration');
ylabel('Negative log density');

%% Tune sampler

[smp,tuneinfo] = tuneSampler(smp,'Start',MAPpars);

figure;
plot(tuneinfo.StepSizeTuningInfo.StepSizeProfile);
xlabel('Iteration');
ylabel('Step size');

fprintf("accratio = %.4f\n", tuneinfo.StepSizeTuningInfo.AcceptanceRatio)

%% Draw samples

NumChains = 4;
chains = cell(NumChains,1);
Burnin = 500;
NumSamples = 1000;
for c = 1:NumChains
    if (c == 1)
        level = 1;
    else
        level = 0;
    end
    chains{c} = drawSamples(smp,'Start',MAPpars + randn(size(MAPpars)), ...
        'Burnin',Burnin,'NumSamples',NumSamples, ...
        'VerbosityLevel',level,'NumPrint',300);
end

%% Examine convergence diagnostics

diags = diagnostics(smp,chains);
truePars = [log(trueSigma^2);mu];
disp(diags)
disp(truePars)

%% Visualize samples

figure;
plot(chains{1}(:,1))
title("log(\sigma^2), Chain 1")

figure;
plot(chains{1}(:,2))
title("\mu_1, Chain 1")

concatenatedSamples = vertcat(chains{:});
figure;
histogram(exp(concatenatedSamples(:,1)))
xline(trueSigma^2,'r-','LineWidth',1)
xline(mean(exp(concatenatedSamples(:,1))),'k-','LineWidth',1)
xlabel("\sigma^2")
ylabel("Frequency")

Fig = figure;
Fig.Position = Fig.Position.*[0.5 0.5 1.5 1.5];
N = length(mu);
ax = gobjects(N,1);
for i = 1:N
    ax(i) = subplot(4,5,i);
    histogram(concatenatedSamples(:,i+1))
    xline(mu(i),'r-','LineWidth',1)
    xline(mean(concatenatedSamples(:,i+1)),'k-','LineWidth',1)
    xlim([-10 10]);
    ax(i).XTickLabel = {};
    ax(i).YTickLabel = {};
end
##### SOURCE END #####
--></body></html>